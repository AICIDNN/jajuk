<?xml version='1.0' encoding='UTF-8'?>
<!--Ant script for packagers only-->
<!--void 3 -->

<project default='package_jar' name='jajuk' basedir='../..'>
	<!--VARIABLES-->

	<!--Distribution release-->
	<property name='version' value='1.4_RC7' />

	<!--Previous release used for JNLP incremental upgrade-->
	<property name='previous_version' value='null' />

	<!--Test flag: values: test or notest -->
	<property name='test' value='test' />

	<!-- ======================= -->
	<!-- | Configuration paths | -->
	<!-- ======================= -->

	<!-- Conf for bflorat server
	<property name='conf_izpackdir' value='/prog/IzPack' />
	<property name='conf_jsmoothgendir' value='/prog/jsmooth-0.9.7' />
	<property name='conf_javahelpdir' value='/prog/api/jh/javahelp' />
	<property name='conf_jnlp-dist' value='/data/java/jnlp-dist' />
	<property name='conf_homeuser' value='/home/bflorat' />
	<property name='conf_uploaddir' value='${rootdir}/upload' />
	<property name='conf_jarbundler' value='/prog/jarbundler-1.9' />
	-->

	<!-- Conf for Jajuk server -->
	<property name='conf_izpackdir' value='/svn-jajuk/tools/IzPack' />
	<property name='conf_jsmoothgendir' value='/svn-jajuk/tools/jsmooth-0.9.9-7' />
	<property name='conf_javahelpdir' value='/svn-jajuk/tools/javahelp/jh2.0/javahelp' />
	<property name='conf_jnlp-dist' value='/svn-jajuk/jnlp-dist' />
	<property name='conf_homeuser' value='/home/jbuild' />
	<property name='conf_uploaddir' value='/var/www/repository.jajuk.info/jajuk/testing/build-1.4' />
	<property name='conf_jarbundler' value='/svn-jajuk/tools/jarbundler-1.9' />

	<!-- ============================== -->
	<!-- | End of configuration paths | -->
	<!-- ============================== -->

	<!--CONST-->
	<property name='rootdir' value='/tmp/jajuk-dist' />
	<property name='distdir' value='${rootdir}/jajuk' />
	<property name='rpmbuilddir' value='${rootdir}/RPMBUILD' />
	<property name='rpmdistdir' value='${rpmbuilddir}/jajuk' />
	<property name='windowsdir' value='${rootdir}/windows' />
	<property name='izpackdir' value='${rootdir}/java' />
	<property name='sourcesdir' value='${rootdir}/sources' />
	<property name='libdir' value='lib' />
	<property name='distfiles' value='dist-files' />
	<property name='nativedir' value='native' />
	<property name='javadir' value='src/main/java' />
	<property name='classdir' value='classes' />
	<property name='javadocdir' value='dist-files/doc/javadoc' />
	<property name='jarname' value='jajuk.jar' />
	<property name='helpsetjarname' value='jajuk-help' />
	<property name='distjarname' value='jajuk-java-installer-' />
	<property name='sourcesdist' value='${sourcesdir}/jajuk-sources-${version}.zip' />
	<property name='helpdir' value='${rootdir}/help' />
	<!-- This is the intermediate directory used to build war file, we use a persisitent 
 	directory to use jar files in next war (each war contains current and previous jars for incremental upgrade) -->
	<property name='jnlpdir' value='${conf_jnlp-dist}/${version}' />
	<property name='previousjnlpdir' value='${conf_jnlp-dist}/${previous_version}' />
	<property name='srcdir' value='${basedir}/src' />


	<target name='startup'>
		<echo message='Building Jajuk release: ${version}' />
		<echo message='Basedir: ${basedir}' />
		<!--Prepare timestamp-->
		<tstamp>
			<format property="JAJUK_TIMESTAMP" pattern="yyyy-MM-dd HH:mm:ss" />
		</tstamp>
	</target>


	<target name='clean' description='o Clean up previous build files'>
		<delete dir='${rootdir}' />
		<delete dir='${jnlpdir}' />
	</target>


	<target name='mkdist_jar'>
		<echo message='Prepare files to build jar package' />
		<mkdir dir='${rootdir}' />
		<mkdir dir='${distdir}' />
		<copy todir='${distdir}/lib'>
			<fileset dir='${libdir}' />
		</copy>
		<mkdir dir='${distdir}/bin' />
		<mkdir dir='${distdir}/${classdir}' />
		<copy todir='${distdir}/src'>
			<fileset dir='${javadir}' />
		</copy>
		<!--copy README and legals file in / for package distribution-->
		<copy todir='${distdir}'>
			<fileset file='${basedir}/src/legals/*.*' />
			<fileset file='${basedir}/src/doc/README.html' />
		</copy>
		<!--copy both README and LICENCE files as must also be in src/ for source distribution-->
		<copy todir='${distdir}/src'>
			<fileset file='${basedir}/src/legals/*.*' />
			<fileset file='${basedir}/src/doc/README.html' />
		</copy>

		<!--copy native dll to bin directory-->
		<copy todir='${distdir}/bin'>
			<fileset file='${basedir}/*.dll' />
		</copy>
		<copy todir='${distdir}/src'>
			<fileset file='${srcdir}/packaging/MANIFEST.MF' />
		</copy>
		<copy todir='${distdir}'>
			<fileset file='${srcdir}/scripts/build.xml' />
		</copy>
		<mkdir dir='${distdir}/dist-files' />
		<copy todir='${distdir}/dist-files/icons'>
			<fileset file='${srcdir}/main/resources/icons/**' />
		</copy>
		<copy todir='${distdir}/dist-files/images'>
			<fileset file='${srcdir}/main/resources/images/**' />
		</copy>
		<copy todir='${distdir}/dist-files/perspectives'>
			<fileset file='${srcdir}/main/resources/perspectives/**' />
		</copy>
		<copy todir='${distdir}'>
			<fileset file='${srcdir}/main/resources/icons/64x64/jajuk-icon-shortcut_64x64.png' />
			<fileset file='${srcdir}/main/resources/icons/16x16/jajuk-uninstall.png' />
		</copy>
		<copy todir='${distdir}'>
			<fileset file='${srcdir}/scripts/jajuk' />
			<fileset file='${srcdir}/scripts/jajuk.bat' />
		</copy>
		<chmod file='${distdir}/jajuk' perm='ugo+rx' />

		<!-- Set build date -->
		<tstamp>
			<format property='build.time' pattern='yyyy/MM/dd HH:mm' />
		</tstamp>
		<echo message='Build time: ${build.time}' />
		<replace dir='${distdir}/src/org/jajuk/util' value='${build.time}'>
			<include name='ITechnicalStrings.java' />
			<replacetoken>DATE_REPLACED_BY_ANT</replacetoken>
		</replace>
		<!-- Set release in code-->
		<replace dir='${distdir}/src/org/jajuk/util' value='${version}'>
			<include name='ITechnicalStrings.java' />
			<replacetoken>VERSION_REPLACED_BY_ANT</replacetoken>
		</replace>
		<!-- Set release in user build.xml file-->
		<replace dir='${distdir}' value='${version}'>
			<include name='build.xml' />
			<replacetoken>VERSION_REPLACED_BY_ANT</replacetoken>
		</replace>
		<!-- Set debug value in scripts-->
		<replace dir='${distdir}' value='-${test}'>
			<include name='jajuk' />
			<include name='jajuk.bat' />
			<replacetoken>TEST_FLAG_REPLACED_BY_ANT</replacetoken>
		</replace>
	</target>


	<target name='mkdist_helpjar'>
		<echo message='Prepare files to build helpjar files' />
		<mkdir dir='${helpdir}' />
	</target>


	<target name='package_jar' description='o Create Jajuk jar file' depends='startup,clean,mkdist_jar,compile'>
		<echo message='Create Jajuk jar file' />
		<jar jarfile='${distdir}/bin/${jarname}' excludes='**/package.html' manifest='${srcdir}/packaging/MANIFEST.MF' compress='true'>
			<fileset dir='${distdir}/${classdir}' />
		</jar>
		<delete dir='${distdir}/${classdir}' />
		<echo message='jajuk.jar had been successfully built in: ${distdir}/bin/${jarname}' />
	</target>


	<target name='package_helpjar' description='o Create Jajuk help jar files' depends='startup,clean,mkdist_helpjar'>
		<echo message='Create Jajuk help jar files' />
		<!--Copy-->
		<copy todir='${helpdir}'>
			<fileset dir='${srcdir}/doc/jajuk-hs' />
		</copy>
		<copy todir='${helpdir}/default'>
			<fileset dir='${srcdir}/doc'>
				<include name='images/**' />
				<include name='icons/**' />
			</fileset>
		</copy>
		<copy todir='${helpdir}/fr'>
			<fileset dir='${srcdir}/doc'>
				<include name='images/**' />
				<include name='icons/**' />
			</fileset>
		</copy>
		<!-- indexer -->
		<!--English-->
		<exec executable='${conf_javahelpdir}/bin/jhindexer' dir='${helpdir}/default'>
			<arg line='-locale en_US html' />
		</exec>
		<!--French-->
		<exec executable='${conf_javahelpdir}/bin/jhindexer' dir='${helpdir}/fr'>
			<arg line='-locale fr_FR html' />
		</exec>
		<!-- jar creation -->
		<jar jarfile='${distdir}/bin/${helpsetjarname}.jar' basedir='${helpdir}/default' />
		<signjar jar="${distdir}/bin/${helpsetjarname}.jar" alias="jajukteam" storepass="passpass" />
		<jar jarfile='${distdir}/bin/${helpsetjarname}_fr.jar' basedir='${helpdir}/fr' />
		<signjar jar="${distdir}/bin/${helpsetjarname}_fr.jar" alias="jajukteam" storepass="passpass" />
		<!-- Copy jajuk jar in the workspace -->
		<copy todir='${basedir}'>
			<fileset file='${distdir}/bin/${helpsetjarname}*.jar' />
		</copy>

		<echo message='${helpsetjarname}.jar had been successfully built in: ${distdir}/bin/${helpsetjarname}.jar' />
		<echo message='${helpsetjarname}_fr.jar had been successfully built in: ${distdir}/bin/${helpsetjarname}_fr.jar' />
	</target>


	<target name='compile'>
		<echo message='Compile the code' />
		<javac destdir='${distdir}/${classdir}' source='1.5' target='1.5' deprecation='true' debug='true' optimize='true' excludes='**/package.html'>
			<src>
				<pathelement path='${distdir}/src'>
				</pathelement>
			</src>
			<classpath>
				<fileset dir='${distdir}/lib'>
					<include name='*.jar'>
					</include>
				</fileset>
			</classpath>
		</javac>
		<mkdir dir='${distdir}/${classdir}/icons' />
		<mkdir dir='${distdir}/${classdir}/images' />
		<mkdir dir='${distdir}/${classdir}/perspectives' />
		<mkdir dir='${distdir}/${classdir}/docs' />
		<!-- Copy files to be embeded into the jar -->
		<copy todir='${distdir}/${classdir}/icons'>
			<fileset dir='${srcdir}/main/resources/icons' />
		</copy>
		<copy todir='${distdir}/${classdir}/images/included'>
			<fileset file='${srcdir}/main/resources/images/included/*' />
		</copy>
		<copy todir='${distdir}/${classdir}/docs'>
			<fileset file='${srcdir}/doc/about.html' />
		</copy>
		<copy todir='${distdir}/${classdir}/org/jajuk/i18n'>
			<fileset file='${javadir}/org/jajuk/i18n/*.properties' />
		</copy>
		<copy todir='${distdir}/${classdir}/org/jajuk/util/log'>
			<fileset file='${javadir}/org/jajuk/util/log/jajuk-log4j-conf.xml' />
		</copy>
		<copy todir='${distdir}/${classdir}/perspectives'>
			<fileset file='${srcdir}/main/resources//perspectives/*.xml' />
		</copy>
	</target>


</project>
